<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        caption="msg://caption"
        class="com.srt.omega.web.dashboards.Salesdashboard"
        messagesPack="com.srt.omega.web.dashboards"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd">
    <dsContext>
        <collectionDatasource id="showsDs"
                              class="com.srt.omega.entity.Show"
                              view="show-view">
            <query>
                <![CDATA[select e from omega$Show e order by e.name]]>
            </query>
        </collectionDatasource>
        <valueCollectionDatasource id="salesByBookingStatusDs">
            <query><![CDATA[select CASE
                        WHEN (b.bookingStatus = 10) THEN 'On_Hold'
                        WHEN (b.bookingStatus = 20) THEN 'Invoiced'
                        WHEN (b.bookingStatus = 30) THEN 'Confirmed'
                        ELSE 'Disbursement_Form_received' END, sum(b.totalPaidTickets)
                            from omega$Booking b
                            where b.show = :ds$showsDs
                            group by b.bookingStatus]]>
            </query>
            <properties>
                <property class="com.srt.omega.entity.Booking" name="bookingStatus"/>
                <property datatype="decimal" name="sum"/>
            </properties>
        </valueCollectionDatasource>
        <valueCollectionDatasource id="paymentCategoryDs">
            <query></query>
            <properties>
                <property datatype="string" name="category"/>
                <property datatype="string" name="totalCapacity"/>
                <property datatype="string" name="paidTickets"/>
                <property datatype="string" name="percentPaidTickets"/>
                <property datatype="string" name="compTickets"/>
                <property datatype="string" name="percentCompTickets"/>
            </properties>
        </valueCollectionDatasource>
        <valueCollectionDatasource id="showSummarySalesDs">
            <query></query>
            <properties>
                <property datatype="string" name="totalShowColumn"/>
                <property datatype="string" name="totalSalesColumn"/>
                <property datatype="string" name="weekendSalesColumn"/>
                <property datatype="string" name="weekdaySalesColumn"/>
                <property datatype="string" name="ticketsAvailableColumn"/>
                <property datatype="string" name="ticketsBookedColumn"/>
            </properties>
        </valueCollectionDatasource>
        <valueCollectionDatasource id="ticketCategoryDs">
            <query></query>
            <properties>
                <property datatype="string" name="category"/>
                <property datatype="string" name="totalCapacity"/>
                <property datatype="string" name="paidTickets"/>
                <property datatype="string" name="percentPaidTickets"/>
                <property datatype="string" name="compTickets"/>
                <property datatype="string" name="percentCompTickets"/>
            </properties>
        </valueCollectionDatasource>

        <valueCollectionDatasource id="salesByIndustryDs">
            <query>
                <![CDATA[select b.organisation.industry, sum(b.totalPaidTickets)
from omega$Booking b
where b.show = :ds$showsDs
group by b.organisation.industry]]>
            </query>
            <properties>
                <property class="com.srt.omega.entity.Booking"
                          name="show"/>
                <property datatype="decimal"
                          name="sum"/>
            </properties>
        </valueCollectionDatasource>
        <valueCollectionDatasource id="individualSalesDs">
            <query>
                <![CDATA[select b.organisation.name, sum(b.totalPaidTickets)
from omega$Booking b
where b.show = :ds$showsDs
group by b.organisation.name]]>
            </query>
            <properties>
                <property class="com.srt.omega.entity.Show"
                          name="show"/>
                <property datatype="decimal"
                          name="sum"/>
            </properties>
        </valueCollectionDatasource>
    </dsContext>
    <dialogMode height="600"
                width="800"/>
    <layout expand="chartGrid"
            spacing="true">
        <grid id="showSelectionGrid" spacing="true">
            <columns count="2"/>
            <rows>
                <row>
                    <lookupField id="showLookup"
                                 caption="Select Show"
                                 optionsDatasource="showsDs"
                                 width="400px"/>

                    <lookupField id="showTimingLookup"
                                 caption="Select Timing"
                                 optionsDatasource="showTimeDs"
                                 width="400px"/>

                </row>
            </rows>
        </grid>


        <grid id="chartGrid"
              align="MIDDLE_CENTER"
              spacing="true">
            <columns count="2"/>
            <rows>
                <row>
                    <table id="tableShowSummaryInfo" settingsEnabled="false" colspan="2" align="MIDDLE_CENTER">
                        <columns>
                            <column id="totalShowColumn" caption="Total Shows"/>
                            <column id="totalSalesColumn" caption="Total Sales"/>
                            <column id="weekendSalesColumn" caption="Weekend Sales"/>
                            <column id="weekdaySalesColumn" caption="Weekday Sales"/>
                            <column id="ticketsAvailableColumn" caption="No of Available Tickets"/>
                            <column id="ticketsBookedColumn" caption="No of Tickets Booked"/>
                        </columns>
                        <rows datasource="showSummarySalesDs"/>
                        <rowsCount/>
                    </table>
                </row>
                <row>
                    <table id="tablePaymentsCategory" caption="Payment Category Summary"
                           settingsEnabled="false">
                        <columns>
                            <column id="category"/>
                            <column id="totalCapacity"/>
                            <column id="paidTickets"/>
                            <column id="percentPaidTickets"/>
                            <column id="compTickets"/>
                            <column id="percentCompTickets"/>
                        </columns>
                        <rows datasource="paymentCategoryDs"/>
                        <rowsCount/>
                    </table>
                    <table id="tableTicketCategory" caption="Ticket Category Summary"
                           settingsEnabled="false">
                        <columns>
                            <column id="category"/>
                            <column id="totalCapacity"/>
                            <column id="paidTickets"/>
                            <column id="percentPaidTickets"/>
                            <column id="compTickets"/>
                            <column id="percentCompTickets"/>

                        </columns>
                        <rows datasource="ticketCategoryDs"/>
                        <rowsCount/>

                    </table>
                </row>
                <row>
                    <chart:pieChart id="salesByIndustry"
                                    caption="Sales By Industry"
                                    datasource="salesByIndustryDs"
                                    titleField="show"
                                    valueField="sum"
                                    balloonText="[[title]]&lt;br&gt;&lt;span style='font-size:14px'&gt;
                        &lt;strong&gt;[[value]]&lt;/strong&gt; ([[percents]]%)&lt;/span&gt;"/>

                    <chart:pieChart id="individualSales"
                                    caption="Sales By Organisation"
                                    datasource="individualSalesDs"
                                    titleField="show"
                                    valueField="sum"
                                    balloonText="[[title]]&lt;br&gt;&lt;span style='font-size:14px'&gt;
                        &lt;strong&gt;[[value]]&lt;/strong&gt; ([[percents]]%)&lt;/span&gt;"/>
                </row>
                <row>
                    <chart:pieChart id="salesByBookingStatus"
                                    caption="Sales By Booking Status"
                                    datasource="salesByBookingStatusDs"
                                    titleField="bookingStatus"
                                    valueField="sum"
                                    balloonText="[[title]]&lt;br&gt;&lt;span style='font-size:14px'&gt;
                        &lt;strong&gt;[[value]]&lt;/strong&gt; ([[percents]]%)&lt;/span&gt;" />
                </row>
            </rows>
        </grid>
    </layout>
</window>